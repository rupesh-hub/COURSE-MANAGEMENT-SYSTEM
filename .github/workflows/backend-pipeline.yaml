name: backend pipeline

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/backend-*.yaml
      - backend/**
      - docker/backend/Dockerfile
      - docker/docker-compose/default/common-config.yaml
      - docker/docker-compose/default/docker-compose.yaml

env:
  IMAGE_NAME: course-management-system
  DOCKER_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKER_LATEST_TAG: latest

jobs:

  # ----------------------------------------------------
  # 1. BUILD BACKEND + TEST + PACKAGE
  # ----------------------------------------------------
  build-backend:
    runs-on: self-hosted
    name: Build backend & generate version
    outputs:
      VERSION: ${{ steps.extract_version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: corretto

      - name: Maven build
        run: |
          cd backend
          ./mvnw -q clean package -DskipTests

      - name: Extract project version
        id: extract_version
        run: |
          cd backend
          VERSION=$(./mvnw -q -Dexec.executable='echo' \
            -Dexec.args='${project.version}' --non-recursive exec:exec | tr -d '[:space:]')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted backend version: '$VERSION'"

  # ----------------------------------------------------
  # 2. BUILD DOCKER IMAGE
  # ----------------------------------------------------
  docker-build:
    runs-on: self-hosted
    needs: build-backend
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          VERSION=${{ needs.build-backend.outputs.VERSION }}
          echo "Using backend version: $VERSION"
          docker build \
            -t ${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:$VERSION \
            -t ${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:latest \
            -f docker/backend/Dockerfile backend \
            --build-arg PROFILE=default \
            --build-arg APP_VERSION=$VERSION

  # ----------------------------------------------------
  # 3. TRIVY SCAN (NO FAIL)
  # ----------------------------------------------------
  trivy-scan:
    runs-on: self-hosted
    needs: docker-build
    steps:
      - name: Run Trivy scan (never fails)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:latest
          format: table
          exit-code: 0
          ignore-unfixed: true
          vuln-type: os,library
          severity: CRITICAL,HIGH

  # ----------------------------------------------------
  # 4. PUSH IMAGE (NO ARTIFACTS)
  # ----------------------------------------------------
  docker-push:
    runs-on: self-hosted
    needs: trivy-scan
    steps:
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_SECRET_KEY }}

      - name: Push images
        run: |
          VERSION=${{ needs.build-backend.outputs.VERSION }}
          echo "Pushing version: '$VERSION'"
          docker push ${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:$VERSION
          docker push ${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:latest

  # ----------------------------------------------------
  # 5. DEPLOY
  # ----------------------------------------------------
  deployment:
    runs-on: self-hosted
    needs: docker-push
    steps:
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy
        run: |
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_IP }} "mkdir -p course-management-system-deployment"
          scp docker/docker-compose/default/docker-compose.yaml \
              ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_IP }}:course-management-system-deployment/
          scp docker/docker-compose/default/common-config.yaml \
              ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_IP }}:course-management-system-deployment/
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_IP }} <<EOF
            cd course-management-system-deployment
            docker compose down
            docker compose pull
            docker compose up -d
          EOF
