name: backend pipeline

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/backend-*.yaml
      - backend/**
      - docker/backend/Dockerfile
      - docker/docker-compose/default/common-config.yaml
      - docker/docker-compose/default/docker-compose.yaml

env:
  IMAGE_NAME: course-management-system
  DOCKER_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKER_LATEST_TAG: latest

jobs:

  # ----------------------------------------------------
  # 1. BUILD BACKEND + TEST + PACKAGE
  # ----------------------------------------------------
  build-backend:
    runs-on: self-hosted
    name: Build backend & store artifact
    outputs:
      VERSION: ${{ steps.extract_version.outputs.VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'corretto'

      - name: Maven build (compile + test + package)
        run: |
          cd backend
          ./mvnw -q clean package

      - name: Extract project version
        id: extract_version
        run: |
          cd backend
          VERSION=$(./mvnw -q -Dexec.executable='echo' \
            -Dexec.args='${project.version}' --non-recursive exec:exec)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar


  # ----------------------------------------------------
  # 2. BUILD DOCKER IMAGE
  # ----------------------------------------------------
  docker-build:
    name: Build docker image & store artifact
    runs-on: self-hosted
    needs: build-backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: corretto

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: backend/target

      - name: Build Docker image
        run: |
          VERSION=${{ needs.build-backend.outputs.VERSION }}
          docker build \
            -t ${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:$VERSION \
            -t ${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:${{ env.DOCKER_LATEST_TAG }} \
            -f docker/backend/Dockerfile backend \
            --build-arg PROFILE=default \
            --build-arg APP_VERSION=$VERSION

      - name: Save docker image as artifact
        run: docker save ${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:${{ env.DOCKER_LATEST_TAG }} -o image.tar

      - name: Upload docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar


  # ----------------------------------------------------
  # 3. TRIVY SCAN (WILL NOT FAIL PIPELINE)
  # ----------------------------------------------------
  trivy-scan:
    name: Scan Docker image
    runs-on: self-hosted
    needs: docker-build
    steps:
      - name: Download docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: Load docker image
        run: docker load -i image.tar

      - name: Run Trivy scan (never fails)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:${{ env.DOCKER_LATEST_TAG }}
          format: table
          exit-code: 0       # <--- IMPORTANT: don't fail pipeline
          ignore-unfixed: true
          vuln-type: os,library
          severity: CRITICAL,HIGH


  # ----------------------------------------------------
  # 4. PUSH IMAGE TO DOCKER HUB
  # ----------------------------------------------------
  docker-push:
    name: Push Docker image to Hub
    runs-on: self-hosted
    needs: trivy-scan
    steps:
      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_SECRET_KEY }}

      - name: Download docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: Load docker image
        run: docker load -i image.tar

      - name: Push images
        run: |
          VERSION=${{ needs.build-backend.outputs.VERSION }}
          docker push ${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:$VERSION
          docker push ${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:latest

      - name: Output final image names
        run: |
          VERSION=${{ needs.build-backend.outputs.VERSION }}
          echo "FINAL IMAGES:"
          echo "${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:$VERSION"
          echo "${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:latest"


  # ----------------------------------------------------
  # 5. DEPLOY TO SERVER
  # ----------------------------------------------------
  deployment:
    name: Deployment
    runs-on: self-hosted
    needs: docker-push
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create deployment folder
        run: |
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_IP }} \
            "mkdir -p course-management-system-deployment"

      - name: Copy docker-compose files
        run: |
          scp docker/docker-compose/default/docker-compose.yaml \
            ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_IP }}:course-management-system-deployment/
          scp docker/docker-compose/default/common-config.yaml \
            ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_IP }}:course-management-system-deployment/

      - name: Deploy new version
        run: |
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_IP }} <<EOF
          cd course-management-system-deployment
          docker compose down
          docker compose pull
          docker compose up -d
          EOF
